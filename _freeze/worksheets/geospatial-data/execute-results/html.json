{
  "hash": "e31652b6aab7ce6acae564b1b4438f6c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Visualizing geospatial data\"\nauthor: \"Claus O. Wilke\"\nformat: live-html\nengine: knitr\nwebr:\n  render-df: gt-interactive\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n## Introduction\n\nIn this worksheet, we will discuss we will discuss how to visualize geospatial data.\n\nFirst we need to load the required R packages. Please wait a moment until the live R session is fully set up and all packages are loaded.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\n#| warning: false\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(colorspace)\n```\n:::\n\n\n\nNext we set up the data. \n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\n#| warning: false\ntexas_income <- readRDS(url(\"https://wilkelab.org/SDS366/datasets/Texas_income.rds\"))\n\nUS_census <- read_csv(\"https://wilkelab.org/SDS366/datasets/US_census.csv\")\ntexas_counties <- US_census |> \n  filter(state == \"Texas\") |>\n  select(FIPS, name, pop2010, area) |>\n  extract(name, \"county\", regex = \"(.+) County\") |>\n  mutate(\n    FIPS = as.character(FIPS),\n    popratio = pop2010/median(pop2010),\n  )\n```\n:::\n\n\n\nWe will be working with the datasets `texas_income` and `texas_counties`. The dataset `texas_income` contains the median income of all counties in Texas, as well as the shape information about each county (stored in the `geometry` column). The column `FIPS` contains a five-digit id code that uniquely represents each county.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\ntexas_income\n```\n:::\n\n\n\nThe dataset `texas_counties` holds information about how many people lived in Texas counties in 2010, as well as the size of each county (column `area`). The column `popratio` is the ratio of the number of inhabitants to the median across all counties. The column `FIPS` contains a five-digit id code that uniquely represents each county.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\ntexas_counties\n```\n:::\n\n\n\n## Wrangling data\n\nBefore we perform any visualizations, we will first gain some experience manipulating data tables containing geospatial information. This does not require us to learn any new concepts, as data tables with geospatial information (i.e., containing a `geometry` column) can be manipulated just like those without.\n\nLet's try this out. Take the `texas_income` table and filter out the rows for the counties \"Travis\" and \"Harris\".\n\n\n\n::: {.cell exercise='sf-wrangling'}\n```{webr}\n#| exercise: sf-wrangling\n\n```\n:::\n\n\n\n::: { .hint exercise=\"sf-wrangling\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\ntexas_income |>\n  filter(___)\n```\n:::\n:::\n\n::: { .solution exercise=\"sf-wrangling\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\ntexas_income |>\n  filter(county %in% c(\"Travis\", \"Harris\"))\n```\n:::\n:::\n\nNow join the `texas_income` table with the `texas_counties` table and then find the five largest counties.\n\n**Hint:** Use the function `left_join()` to join the tables, and use the functions `arrange()` and `slice()` to find the five largest counties.\n\n\n\n::: {.cell exercise='sf-wrangling2'}\n```{webr}\n#| exercise: sf-wrangling2\n\n```\n:::\n\n\n\n::: { .hint exercise=\"sf-wrangling2\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\ntexas_income |>\n  left_join(___) |>\n  ___\n```\n:::\n:::\n\n::: { .hint exercise=\"sf-wrangling2\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\ntexas_income |>\n  left_join(texas_counties) |>\n  arrange(___) |>\n  slice(___)\n```\n:::\n:::\n\n\n::: { .solution exercise=\"sf-wrangling2\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\ntexas_income |>\n  left_join(texas_counties) |>\n  arrange(desc(area)) |>\n  slice(1:5)\n```\n:::\n:::\n\n## Visualizing simple features\n\nWe can visualize datasets containing simple features with the function `geom_sf()`. This geom is very simple to use, as it automatically finds the `geometry` column and draws it in the appropriate coordinate system. All we need to think about is whether we want to apply a color mapping, e.g. to make a choropleth.\n\nTry this out by making a plot of the counties in Texas, without applying any kind of aesthetic mapping. Remember, the dataset `texas_income` contains the required geometry information.\n\n\n\n::: {.cell exercise='geom-sf'}\n```{webr}\n#| exercise: geom-sf\n\n```\n:::\n\n\n\n::: { .hint exercise=\"geom-sf\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(texas_income) +\n  ___\n```\n:::\n:::\n\n::: { .solution exercise=\"geom-sf\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(texas_income) +\n  geom_sf()\n```\n:::\n:::\n\nNow map the data column `median_income` to the fill color. Also choose an appropriate color scale from the **colorspace** package. \n\n**Hint:** You can see the available color palettes [here.](https://colorspace.r-forge.r-project.org/articles/ggplot2_color_scales.html#available-palettes-1)\n\n\n\n::: {.cell exercise='geom-sf-fill'}\n```{webr}\n#| exercise: geom-sf-fill\n\n```\n:::\n\n\n\n::: { .hint exercise=\"geom-sf-fill\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(texas_income) +\n  geom_sf(aes(fill = ___)) +\n  scale_fill_continuous_sequential(palette = ___)\n```\n:::\n:::\n\n::: { .solution exercise=\"geom-sf-fill\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(texas_income) +\n  geom_sf(aes(fill = median_income)) +\n  scale_fill_continuous_sequential(palette = \"Lajolla\")\n```\n:::\n:::\n\nFinally, make a plot that highlights the 10 smallest counties in Texas. This will require you to join `texas_income` and `texas_counties` first.\n\n\n\n::: {.cell exercise='geom-sf-join'}\n```{webr}\n#| exercise: geom-sf-join\n\n```\n:::\n\n\n\n::: { .hint exercise=\"geom-sf-join\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\ntexas_income |>\n  left_join(texas_counties) |>\n  mutate(\n    smallest = rank(area) <= 5\n  )\n```\n:::\n:::\n\n::: { .hint exercise=\"geom-sf-join\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\ntexas_income |>\n  left_join(texas_counties) |>\n  mutate(\n    smallest = rank(area) <= 5\n  ) |>\n  ggplot() +\n  geom_sf(aes(fill = ___))\n```\n:::\n:::\n\n::: { .hint exercise=\"geom-sf-join\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\ntexas_income |>\n  left_join(texas_counties) |>\n  mutate(\n    smallest = rank(area) <= 5\n  ) |>\n  ggplot() +\n  geom_sf(aes(fill = smallest))\n```\n:::\n:::\n\n::: { .solution exercise=\"geom-sf-join\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\ntexas_income |>\n  left_join(texas_counties) |>\n  mutate(\n    smallest = rank(area) <= 5\n  ) |>\n  ggplot() +\n  geom_sf(aes(fill = smallest), size = 0.2) +\n  scale_fill_manual(\n    values = c(\n      `TRUE` = \"#D55E00\",\n      `FALSE` = \"#E8EEF9\"\n    )\n  )\n```\n:::\n:::\n\n## Changing the projection\n\nOne major benefit of the sf framework is that different map projections are built in and supported out-of-the-box. We can refer to projections by their EPSG codes, and these codes can be looked up on websites such as <https://spatialreference.org/> or <https://epsg.io/>.\n\nWe can set the coordinate system via `coord_sf()`, which takes an argument `crs` that specifies the Coordinate Reference System (CRS). For example, `coord_sf(crs = 3083)` will select a Texas Centric Albers Equal Area projection (<https://spatialreference.org/ref/epsg/3083/>). Try this out.\n\n\n\n::: {.cell exercise='coord-sf'}\n```{webr}\n#| exercise: coord-sf\n\n```\n:::\n\n\n\n::: { .hint exercise=\"coord-sf\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(texas_income) +\n  geom_sf() +\n  ___\n```\n:::\n:::\n\n::: { .solution exercise=\"coord-sf\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(texas_income) +\n  geom_sf() +\n  coord_sf(crs = 3083)\n```\n:::\n:::\n\nHere are a few other coordinate systems to try out, to see how different projections affect how the map looks.\n\n- [EPSG:32139:](https://spatialreference.org/ref/epsg/32139/) Texas Centric Lambert Conformal Conic; notice the subtle changes compared to 3083.\n- [EPSG:3857:](https://spatialreference.org/ref/sr-org/7483/) Web Mercator, used e.g. by Google Maps; not a good projection in practice.\n- [EPSG:3338:](https://spatialreference.org/ref/epsg/3338/) Alaska Albers equal area; not appropriate for Texas, but shows more extreme changes in the plot\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}