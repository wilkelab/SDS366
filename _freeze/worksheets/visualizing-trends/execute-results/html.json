{
  "hash": "e181aecf4c9b88ce46b4d192273f6e7d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Visualizing trends\"\nauthor: \"Claus O. Wilke\"\nformat: live-html\nengine: knitr\nwebr:\n  render-df: gt-interactive\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n## Introduction\n\nIn this worksheet, we will discuss how to fit linear regressions (straight lines) and smooth curves to the observations in a dataset.\n\nFirst we need to load the required R packages. Please wait a moment until the live R session is fully set up and all packages are loaded.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| warning: false\n#| edit: false\nlibrary(tidyverse)\n```\n:::\n\n\n\nNext we set up the data.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\n#| warning: false\nblue_jays <- read_csv(\"https://wilkelab.org/SDS366/datasets/blue_jays.csv\")\nbiorxiv_growth <- read_csv(\"https://wilkelab.org/SDS366/datasets/preprints.csv\") |>\n  filter(archive == \"bioRxiv\", count > 0) |>\n  select(date_dec, count)\ncars93 <- read_csv(\"https://wilkelab.org/SDS366/datasets/cars93.csv\")\n```\n:::\n\n\n\nWe will be working with three datasets, `blue_jays`, `biorxiv_growth`, and `cars93`. The `blue_jays` dataset contains various measurements taken on blue jay birds.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\nblue_jays\n```\n:::\n\n\n\nThe `biorxiv_growth` dataset contains the number of article submissions per month to the bioRxiv preprint server. Each row corresponds to one month, and the column `date_dec` shows the date in decimal form. (For example, Feb. 1 2014 is 2014.085, and March 1 2014 is 2014.162. This representation allows us to treat dates as numerical values.)\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\nbiorxiv_growth\n```\n:::\n\n\n\nThe `cars93` dataset contains information about various passenger cars that were on the market in 1993.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\ncars93\n```\n:::\n\n\n\n\n## Fitting linear trend lines\n\nWe start with simple linear regression lines. These can be generated with `geom_smooth(method = \"lm\")`. Try this on the `blue_jays` dataset. Make a scatter plot of head length (`head_length_mm`) versus body mass (`body_mass_g`) and add a regression line.\n\n\n\n::: {.cell exercise='blue-jays-regression'}\n```{webr}\n#| exercise: blue-jays-regression\n\n```\n:::\n\n\n\n::: { .hint exercise=\"blue-jays-regression\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(blue_jays, aes(body_mass_g, head_length_mm)) +\n  geom_point() +\n  ___\n```\n:::\n:::\n\n::: { .solution exercise=\"blue-jays-regression\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(blue_jays, aes(body_mass_g, head_length_mm)) +\n  geom_point() +\n  geom_smooth(method = \"lm\")\n```\n:::\n:::\n\nYou can turn off the confidence band by setting `se = FALSE`. Try this out. And also change the color of the regression line to black.\n\n\n\n::: {.cell exercise='blue-jays-regression2'}\n```{webr}\n#| exercise: blue-jays-regression2\n\n```\n:::\n\n\n\n::: { .hint exercise=\"blue-jays-regression2\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(blue_jays, aes(body_mass_g, head_length_mm)) +\n  geom_point() +\n  geom_smooth(\n    method = \"lm\",\n    se = ___,\n    color = ___\n  )\n```\n:::\n:::\n\n::: { .solution exercise=\"blue-jays-regression2\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(blue_jays, aes(body_mass_g, head_length_mm)) +\n  geom_point() +\n  geom_smooth(\n    method = \"lm\",\n    se = FALSE,\n    color = \"black\"\n  )\n```\n:::\n:::\n\nNow color the points by the birds' sex and generate two separate regression lines, one for each sex.\n\n\n\n::: {.cell exercise='blue-jays-regression-sex'}\n```{webr}\n#| exercise: blue-jays-regression-sex\n\n```\n:::\n\n\n\n::: { .hint exercise=\"blue-jays-regression-sex\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(blue_jays, aes(body_mass_g, head_length_mm, color = ___)) +\n  geom_point() +\n  geom_smooth(___)\n```\n:::\n:::\n\n::: { .solution exercise=\"blue-jays-regression-sex\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(blue_jays, aes(body_mass_g, head_length_mm, color = sex)) +\n  geom_point() +\n  geom_smooth(method = \"lm\", se = FALSE)\n```\n:::\n:::\n\nNow do the same but instead of coloring by sex you facet by sex.\n\n\n\n::: {.cell exercise='blue-jays-regression-facet'}\n```{webr}\n#| exercise: blue-jays-regression-facet\n\n```\n:::\n\n\n\n::: { .hint exercise=\"blue-jays-regression-facet\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(blue_jays, aes(body_mass_g, head_length_mm)) +\n  geom_point() +\n  geom_smooth(method = \"lm\", se = FALSE) +\n  facet_wrap(___)\n```\n:::\n:::\n\n::: { .solution exercise=\"blue-jays-regression-facet\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(blue_jays, aes(body_mass_g, head_length_mm)) +\n  geom_point() +\n  geom_smooth(method = \"lm\", se = FALSE) +\n  facet_wrap(~sex)\n```\n:::\n:::\n\n## Linear trend lines in log-transformed data\n\nThe blue jay example displayed a nice linear relationship between the variable on the x axis (body mass) and the variable on the y axis (head length). Linear relationships arise in many contexts, but they are not the only type of relationship we encounter in practice. Another commonly encountered relationship is exponential growth, where some quantity increases at a constant rate over time.\n\nAs an example of exponential growth, we will examine the `biorxiv_growth` dataset. This dataset contains the number of monthly article submissions to the bioRxiv preprint server from November 2013 to March 2018. A preprint server is a website to which scientists submit their research articles before they are formally published. The bioRxiv server started operation in late 2013, and it experienced rapid growth in subsequent years.\n\nFirst, make a simple scatter plot of monthly submissions (column `count`) versus time (column `date_dec`).\n\n\n\n::: {.cell exercise='biorxiv-scatter'}\n```{webr}\n#| exercise: biorxiv-scatter\n\n```\n:::\n\n\n\n::: { .hint exercise=\"biorxiv-scatter\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(biorxiv_growth, aes(date_dec, count)) +\n  ___\n```\n:::\n:::\n\n::: { .solution exercise=\"biorxiv-scatter\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(biorxiv_growth, aes(date_dec, count)) +\n  geom_point()\n```\n:::\n:::\n\nNow add a linear regression line. You should see that this does not look correct at all for this dataset.\n\n\n\n::: {.cell exercise='biorxiv-linear-reg'}\n```{webr}\n#| exercise: biorxiv-linear-reg\n\n```\n:::\n\n\n\n::: { .hint exercise=\"biorxiv-linear-reg\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(biorxiv_growth, aes(date_dec, count)) +\n  geom_point() +\n  ___\n```\n:::\n:::\n\n::: { .solution exercise=\"biorxiv-linear-reg\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(biorxiv_growth, aes(date_dec, count)) +\n  geom_point() +\n  geom_smooth(method = \"lm\")\n```\n:::\n:::\n\nWe could try to fit an exponential curve to the data points, but such fits tend to be not very accurate. Instead, it is usually better to fit a straight line in log space. To do so, you need to plot the count data on a log scale. Remember that you can make an axis logarithmic by adding `scale_x_log10()` or `scale_y_log10()` to the plot, depending on which axis you want to transform.\n\n\n\n::: {.cell exercise='biorxiv-log'}\n```{webr}\n#| exercise: biorxiv-log\n\n```\n:::\n\n\n\n::: { .hint exercise=\"biorxiv-log\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(biorxiv_growth, aes(date_dec, count)) +\n  geom_point() +\n  geom_smooth(method = \"lm\") +\n  ___\n```\n:::\n:::\n\n::: { .solution exercise=\"biorxiv-log\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(biorxiv_growth, aes(date_dec, count)) +\n  geom_point() +\n  geom_smooth(method = \"lm\") +\n  scale_y_log10()\n```\n:::\n:::\n\nNow you can see how closely the points follow the exponential growth pattern. Exponential growth creates a strict linear relationship in log-space.\n\n### Creating a legend for the regression line\n\nWhenever we are creating a plot with data points and a regression line, we may want to add a legend that annotates both of these visual elements, as demonstrated in the following plot.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| label: biorxiv-log-legend-demo\n#| edit: false\n#| echo: false\n#| fig-width: 6.5\n#| fig-height: 4\nggplot(biorxiv_growth, aes(date_dec, count)) +\n  geom_point(aes(color = \"original data\")) +\n  geom_smooth(\n    aes(color = \"regression line\"),\n    method = \"lm\",\n    formula = y ~ x\n  ) +\n  scale_y_log10() +\n  scale_color_manual(\n    name = NULL,\n    values = c(\"black\", \"firebrick4\")\n  )\n```\n:::\n\n\n\nHow can we coax ggplot to produce such a legend? We are used to mapping a variable to `color` or `fill` and ggplot creates a legend for this mapping, but here the situation is different. We're not mapping a particular variable in the data, we're using two separate geoms.\n\nThe solution is that we need to set up a placeholder mapping, such as `aes(color = \"original data\")`. A mapping defined with `aes()` doesn't always have to refer to a data column in the original data, it can also refer to a constant value provided with the mapping. So, if we give each geom its own mapping, with a different string (e.g., `\"original data\"` and `\"regression line\"`), we will get a legend for the aesthetic that we used in the mapping. Try this out with the `color` aesthetic.\n\n\n\n::: {.cell exercise='biorxiv-log-legend'}\n```{webr}\n#| exercise: biorxiv-log-legend\n\n```\n:::\n\n\n\n::: { .hint exercise=\"biorxiv-log-legend\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(biorxiv_growth, aes(date_dec, count)) +\n  geom_point(aes(color = ___)) +\n  geom_smooth(aes(color = ___), method = \"lm\") +\n  scale_y_log10()\n```\n:::\n:::\n\n::: { .solution exercise=\"biorxiv-log-legend\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(biorxiv_growth, aes(date_dec, count)) +\n  geom_point(aes(color = \"original data\")) +\n  geom_smooth(aes(color = \"regression line\"), method = \"lm\") +\n  scale_y_log10()\n```\n:::\n:::\n\n\n## Smoothing lines\n\nWhen you use `geom_smooth()` without any `method` argument, it will create a nonlinear smoothing line that provides a reasonable representation of the x-y relationship in the data. This is a good choice when a simple linear regression is not appropriate.\n\n[Technically, `geom_smooth()` fits a LOESS estimator (locally estimated scatterplot smoothing) when there are fewer than 1000 observations and a GAM estimator (generalized additive model) when there are more observations. The LOESS estimator tends to produce slightly better visual results but is slow for large datasets.]\n\nTo try this out, make a scatter plot of fuel tank capacity (`Fuel.tank.capacity`) versus car price (`Price`) in the `cars93` dataset and add a smoothing line. Fuel tank capacity does not continue to increase the more expensive a car gets, therefore a linear regression is not appripriate in this context.\n\n\n\n::: {.cell exercise='cars-smooth'}\n```{webr}\n#| exercise: cars-smooth\n\n```\n:::\n\n\n\n::: { .hint exercise=\"cars-smooth\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(cars93, aes(Price, Fuel.tank.capacity)) +\n  ___ + \n  ___\n```\n:::\n:::\n\n::: { .solution exercise=\"cars-smooth\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(cars93, aes(Price, Fuel.tank.capacity)) +\n  geom_point() + \n  geom_smooth()\n```\n:::\n:::\n\n\nYou can adjust the smoothness of the fitted curve with the `span` argument. Try `span` values between 0.2 and 1.5.\n\n\n\n::: {.cell exercise='cars-smooth2'}\n```{webr}\n#| exercise: cars-smooth2\n\n```\n:::\n\n\n\n::: { .hint exercise=\"cars-smooth2\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(cars93, aes(Price, Fuel.tank.capacity)) +\n  geom_point() + \n  geom_smooth(\n    span = ___\n  )\n```\n:::\n:::\n\n::: { .solution exercise=\"cars-smooth2\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(cars93, aes(Price, Fuel.tank.capacity)) +\n  geom_point() + \n  geom_smooth(\n    span = 0.2\n  )\n\nggplot(cars93, aes(Price, Fuel.tank.capacity)) +\n  geom_point() + \n  geom_smooth(\n    span = 1.5\n  )\n```\n:::\n:::\n\nYou can also explicitly force a GAM estimator by setting `method = \"gam\"`. However, in this case you need to also provide a formula that specifies the particular smoothing functions you want to use. For example, `formula = y ~ s(x, k = 3)` creates thin-plate regression splines with three knots. Try this out. Also try different values of `k`.\n\n\n\n::: {.cell exercise='cars-gam'}\n```{webr}\n#| exercise: cars-gam\n\n```\n:::\n\n\n\n::: { .hint exercise=\"cars-gam\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\nggplot(cars93, aes(Price, Fuel.tank.capacity)) +\n  geom_point() + \n  geom_smooth(\n    method = ___,\n    formula = ___\n  )\n```\n:::\n:::\n\n::: { .solution exercise=\"cars-gam\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\nggplot(cars93, aes(Price, Fuel.tank.capacity)) +\n  geom_point() + \n  geom_smooth(\n    method = \"gam\",\n    formula = y ~ s(x, k = 3)\n  )\n```\n:::\n:::\n\n\nThere are many available options for the formula describing the desired GAM estimator. These options are fully described in the [**mgcv** reference documentation.](https://cran.r-project.org/web/packages/mgcv/mgcv.pdf)\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}