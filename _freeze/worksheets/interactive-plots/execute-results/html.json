{
  "hash": "9643cc5b0e1a1920a38348facb4dc1cd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Interactive plots\"\nauthor: \"Claus O. Wilke\"\nformat: live-html\nengine: knitr\nwebr:\n  render-df: gt-interactive\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n## Introduction\n\nIn this worksheet, we will discuss how to combine several **ggplot2** plots into one compound figure.\n\nFirst we need to load the required R packages. Please wait a moment until the live R session is fully set up and all packages are loaded.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| warning: false\n#| edit: false\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(ggiraph)\nlibrary(glue)\nlibrary(patchwork)\n```\n:::\n\n\n\nNext we set up the data.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\n#| warning: false\ntexas_income <- readRDS(url(\"https://wilkelab.org/SDS366/datasets/Texas_income.rds\")) |>\n  select(-county)\n\nUS_census <- read_csv(\"https://wilkelab.org/SDS366/datasets/US_census.csv\")\ntx_census <- US_census |> \n  filter(state == \"Texas\") |>\n  select(FIPS, name, pop2010, area) |>\n  extract(name, \"county\", regex = \"(.+) County\") |>\n  mutate(\n    FIPS = as.character(FIPS),\n    popratio = pop2010/median(pop2010),\n  )\n\ntexas_counties <- left_join(texas_income, tx_census, by = \"FIPS\")\n```\n:::\n\n\n\nWe will be working with the dataset `texas_counties`. This dataset  contains various pieces of information about each county in Texas, such as the number of people living in the county in 2010 (`pop2010`), the size of each county (column `area`), and the median income (`median_income`). The column `popratio` is the ratio of the number of inhabitants to the median across all counties. The dataset also contains the shape information about each county (stored in the `geometry` column). The column `FIPS` contains a five-digit id code that uniquely represents each county.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\ntexas_counties\n```\n:::\n\n\n\n## Interactice scatterplots\n\nThe **ggiraph** package provides the simplest means towards adding a moderate amount of interactivity into **ggplot2** plots. It makes it quite straightforward to produce interactive tooltips, interactive highlighting, and the ability to execute actions in the browser (such as opening a new page) when the user clicks on specific elements in the plot.\n\nAs a first example, we will create an interactive version of the following plot, which shows median income in Texas counties versus the number of inhabitants of that county.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\ntexas_scatter <- texas_counties |>\n  ggplot(aes(pop2010, median_income)) +\n  geom_point(na.rm = TRUE, size = 2) +\n  scale_x_log10()\n\ntexas_scatter\n```\n:::\n\n\n\nTo turn this plot interactive, we need to make at least the following three modifications:\n\n1. Replace the geom with the appropriate interactive version. For example, `geom_point()` is replaced by `geom_point_interactive()`.\n\n2. Add an interactive aesthetic. For example, the `tooltip` aesthetic sets the contents of tooltips that show when hovering over the data points.\n\n3. Display the interactive plot object by calling the `girafe()` function with the argument `ggobj`. For example, if your **ggplot2** plot is stored in a variable `p`, you would call `girafe(ggobj = p)`.\n\nMake these modifications to the above plot to create an interactive version.\n\n\n\n::: {.cell exercise='income-vs-popsize'}\n```{webr}\n#| exercise: income-vs-popsize\ntexas_scatter <- texas_counties |>\n  ggplot(aes(pop2010, median_income)) +\n  geom_point(na.rm = TRUE, size = 2) +\n  scale_x_log10()\n\ntexas_scatter\n```\n:::\n\n\n\n::: { .hint exercise=\"income-vs-popsize\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\ntexas_scatter <- texas_counties |>\n  ggplot(aes(pop2010, median_income)) +\n  geom_point_interactive(\n    aes(tooltip = ___),\n    na.rm = TRUE, size = 2\n  ) +\n  scale_x_log10()\n\ngirafe(\n  ggobj = ___\n)\n```\n:::\n:::\n\n::: { .solution exercise=\"income-vs-popsize\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\ntexas_scatter <- texas_counties |>\n  ggplot(aes(pop2010, median_income)) +\n  geom_point_interactive(\n    aes(tooltip = county),\n    na.rm = TRUE, size = 2\n  ) +\n  scale_x_log10()\n\ngirafe(\n  ggobj = texas_scatter\n)\n```\n:::\n:::\n\nIn addition to the `tooltip` aesthetic, there is also the `data_id` aesthetic, which enables highlighting of the selected point(s). If each element has its own `data_id` then elements get highlighted individually. Alternatively, if elements share their `data_id` value then they get highlighted jointly.\n\nFirst, try individual highlighting, by using `county` as the `data_id`.\n\n\n\n::: {.cell exercise='income-vs-popsize2'}\n```{webr}\n#| exercise: income-vs-popsize2\n\n```\n:::\n\n\n\n::: { .hint exercise=\"income-vs-popsize2\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\ntexas_scatter <- texas_counties |>\n  ggplot(aes(pop2010, median_income)) +\n  geom_point_interactive(\n    aes(\n      tooltip = county,\n      data_id = ___\n    ),\n    na.rm = TRUE, size = 2\n  ) +\n  scale_x_log10()\n\ngirafe(\n  ggobj = texas_scatter\n)\n```\n:::\n:::\n\n::: { .solution exercise=\"income-vs-popsize2\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\ntexas_scatter <- texas_counties |>\n  ggplot(aes(pop2010, median_income)) +\n  geom_point_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    na.rm = TRUE, size = 2\n  ) +\n  scale_x_log10()\n\ngirafe(\n  ggobj = texas_scatter\n)\n```\n:::\n:::\n\nNext, try joint highlighting, by creating two groups: one for counties with a median income above $60,000 and one for all other counties.\n\n\n\n::: {.cell exercise='income-vs-popsize3'}\n```{webr}\n#| exercise: income-vs-popsize3\n\n```\n:::\n\n\n\n::: { .hint exercise=\"income-vs-popsize3\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\ntexas_scatter <- texas_counties |>\n  mutate(\n    income = ifelse(___)\n  ) |>\n  ggplot(aes(pop2010, median_income, color = ___)) +\n  geom_point_interactive(\n    aes(\n      tooltip = county,\n      data_id = ___\n    ),\n    na.rm = TRUE, size = 2\n  ) +\n  scale_x_log10()\n\ngirafe(\n  ggobj = texas_scatter\n)\n```\n:::\n:::\n\n::: { .solution exercise=\"income-vs-popsize3\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\ntexas_scatter <- texas_counties |>\n  mutate(\n    income = ifelse(median_income > 60000, \"high\", \"low\")\n  ) |>\n  ggplot(aes(pop2010, median_income, color = income)) +\n  geom_point_interactive(\n    aes(\n      tooltip = county,\n      data_id = income\n    ),\n    na.rm = TRUE, size = 2\n  ) +\n  scale_x_log10()\n\ngirafe(\n  ggobj = texas_scatter\n)\n```\n:::\n:::\n\nYou can customize how tooltips and highlighted data points appear by providing the argument `options` in the `girafe()` function. Options are separated out by tooltip options, hover options, etc. which are provided inside a `list()`. Tooltip options are set via `opts_tooltip()`, and hover options are set via `opts_hover()`. Both functions take an argument `css` which takes CSS declarations such as `background: #F5F5F5;` or `fill: blue;`. Thus, customization code could look as follows:\n\n```r\ngirafe(\n  ggobj = texas_scatter,\n  options = list(\n    opts_tooltip(\n      css = \"background: #F5F5F5; color: black;\"\n    ),\n    opts_hover(\n      css = \"fill: orange;\"\n    )\n  )\n)\n```\n\nTry this out.\n\n\n\n::: {.cell exercise='income-vs-popsize4'}\n```{webr}\n#| exercise: income-vs-popsize4\ntexas_scatter <- texas_counties |>\n  ggplot(aes(pop2010, median_income)) +\n  geom_point_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    na.rm = TRUE, size = 2\n  ) +\n  scale_x_log10()\n\ngirafe(\n  ggobj = texas_scatter,\n  options = ___\n)\n```\n:::\n\n\n\n::: { .hint exercise=\"income-vs-popsize4\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\ntexas_scatter <- texas_counties |>\n  ggplot(aes(pop2010, median_income)) +\n  geom_point_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    na.rm = TRUE, size = 2\n  ) +\n  scale_x_log10()\n\ngirafe(\n  ggobj = texas_scatter,\n  options = list(\n    opts_tooltip(\n      css = ___\n    ),\n    opts_hover(\n      css = ___\n    )\n  )\n)\n```\n:::\n:::\n\n::: { .solution exercise=\"income-vs-popsize4\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\ntexas_scatter <- texas_counties |>\n  ggplot(aes(pop2010, median_income)) +\n  geom_point_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    na.rm = TRUE, size = 2\n  ) +\n  scale_x_log10()\n\ngirafe(\n  ggobj = texas_scatter,\n  options = list(\n    opts_tooltip(\n      css = \"background: #F5F5F5; color: #191970;\"\n    ),\n    opts_hover(\n      css = \"fill: #D83832;\"\n    )\n  )\n)\n```\n:::\n:::\n\nAlso try different CSS properties to see which effect they have. For example, for the tooltip CSS, try `padding` [(docs)](https://developer.mozilla.org/en-US/docs/Web/CSS/padding). For the hove CSS, try `stroke` [(docs)](https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/stroke) or `stroke-width` [(docs)](https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/stroke-width).\n\n## Interactive maps\n\nWe can also make interactive maps. This requires using `geom_sf_interactive()` instead of `geom_sf()`, and again using aesthetics such as `tooltip` or `data_id`.\n\nAs an example, consider this non-interactive plot of median income in Texas counties.\n\n\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\ntexas_county_map <- texas_counties %>%\n  ggplot(aes(fill = median_income)) +\n  geom_sf(\n    size = 0.2, color = \"black\"\n  ) +\n  scale_fill_viridis_c(option = \"E\") +\n  theme_minimal()\n\ntexas_county_map\n```\n:::\n\n\n\nMake it interactive, such that by hovering over the map counties get highlighted and a tooltip shows the county name.\n\n\n\n::: {.cell exercise='texas-map'}\n```{webr}\n#| exercise: texas-map\n\n```\n:::\n\n\n\n::: { .solution exercise=\"texas-map\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\ntexas_county_map <- texas_counties %>%\n  ggplot(aes(fill = median_income)) +\n  geom_sf_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    size = 0.2, color = \"black\"\n  ) +\n  scale_fill_viridis_c(option = \"E\") +\n  theme_minimal()\n\ngirafe(\n  ggobj = texas_county_map\n)\n```\n:::\n:::\n\nWe can also make the counties in the map clickable, by providing an `onclick` aesthetic. The aesthetic needs to be provided with strings holding JavaScript code that should be executed when the user clicks on the element. For example, to open the Wikipedia page for Travis County we would need to provide the following code snippet:\n```js\nwindow.open(\"https://en.wikipedia.org/wiki/Travis County, Texas\")\n```\n\nIntegrate this into the previous map by writing code that generates the JavaScript snippets for each county and maps them onto the `onclick` aesthetic. **Hint:** The `glue()` function will be very helpful here.\n\n\n\n::: {.cell exercise='texas-map2'}\n```{webr}\n#| exercise: texas-map2\n\n```\n:::\n\n\n\n::: { .hint exercise=\"texas-map2\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\ntexas_county_map <- texas_counties %>%\n  mutate(\n    onclick = glue(___)\n  ) %>%\n  ggplot(aes(fill = median_income)) +\n  geom_sf_interactive(\n    aes(\n      tooltip = county,\n      data_id = county,\n      onclick = ___\n    ),\n    size = 0.2, color = \"black\"\n  ) +\n  scale_fill_viridis_c(option = \"E\") +\n  theme_minimal()\n\ngirafe(\n  ggobj = texas_county_map\n)\n```\n:::\n:::\n\n::: { .solution exercise=\"texas-map2\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\ntexas_county_map <- texas_counties %>%\n  mutate(\n    onclick = glue('window.open(\"https://en.wikipedia.org/wiki/{county} County, Texas\")')\n  ) %>%\n  ggplot(aes(fill = median_income)) +\n  geom_sf_interactive(\n    aes(\n      tooltip = county,\n      data_id = county,\n      onclick = onclick\n    ),\n    size = 0.2, color = \"black\"\n  ) +\n  scale_fill_viridis_c(option = \"E\") +\n  theme_minimal()\n\ngirafe(\n  ggobj = texas_county_map\n)\n```\n:::\n:::\n\nInteractive maps become particularly useful if you combine them with one or more additional plots that show further information, e.g. a scatterplot. Then, we can highlight a county in the map and the corresponding data point in the scatterplot or vice versa. We will do this by combining the scatter plot from the previous section with the Texas map from this section. You can combine two plots with the function `plot_grid()`, which takes as argument the two plots to combine, e.g. `plot_grid(texas_scatter, texas_county_map)`. This can be used as the `ggobj` in `girafe()`.\n\n**Hint:** Set `width_svg = 8` and `height_svg = 4` in the `girafe()` function to obtain an appropriate plot layout.\n\n\n\n::: {.cell exercise='texas-map3'}\n```{webr}\n#| exercise: texas-map3\n\n```\n:::\n\n\n\n::: { .hint exercise=\"texas-map3\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\n# first make the scatter plot\ntexas_scatter <- texas_counties %>%\n  ggplot(aes(pop2010, median_income)) +\n  geom_point_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    na.rm = TRUE, size = 3\n  ) +\n  scale_x_log10() +\n  theme_bw()\n```\n:::\n:::\n\n::: { .hint exercise=\"texas-map3\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\n# first make the scatter plot\ntexas_scatter <- texas_counties %>%\n  ggplot(aes(pop2010, median_income)) +\n  geom_point_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    na.rm = TRUE, size = 3\n  ) +\n  scale_x_log10() +\n  theme_bw()\n\n# then make the map\ntexas_county_map <- texas_counties %>%\n  ggplot() +\n  geom_sf_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    size = 0.2, color = \"black\"\n  ) +\n  theme_void()\n```\n:::\n:::\n\n::: { .hint exercise=\"texas-map3\" }\n::: { .callout-tip title=\"Hint\" collapse=\"false\"}\n```r\n# first make the scatter plot\ntexas_scatter <- texas_counties %>%\n  ggplot(aes(pop2010, median_income)) +\n  geom_point_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    na.rm = TRUE, size = 3\n  ) +\n  scale_x_log10() +\n  theme_bw()\n\n# then make the map\ntexas_county_map <- texas_counties %>%\n  ggplot() +\n  geom_sf_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    size = 0.2, color = \"black\"\n  ) +\n  theme_void()\n\n# then combine\ngirafe(\n  ggobj = (___ | ___),\n  width_svg = 8,\n  height_svg = 4\n)\n```\n:::\n:::\n\n::: { .solution exercise=\"texas-map3\" }\n::: { .callout-tip title=\"Solution\" collapse=\"false\"}\n```r\n# first make the scatter plot\ntexas_scatter <- texas_counties %>%\n  ggplot(aes(pop2010, median_income)) +\n  geom_point_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    na.rm = TRUE, size = 3\n  ) +\n  scale_x_log10() +\n  theme_bw()\n\n# then make the map\ntexas_county_map <- texas_counties %>%\n  ggplot() +\n  geom_sf_interactive(\n    aes(\n      tooltip = county,\n      data_id = county\n    ),\n    size = 0.2, color = \"black\"\n  ) +\n  theme_void()\n\n# then combine\ngirafe(\n  ggobj = (texas_scatter | texas_county_map),\n  width_svg = 8,\n  height_svg = 4\n)\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}